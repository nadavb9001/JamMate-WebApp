<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JamMate BLE Controller</title>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/components.css">
</head>
<body>

    <!-- ============================================================
         HEADER
         Left:  status LED + device name
         Right: Master knob | BPM knob | fullscreen btn | connect btn
    ============================================================= -->
    <div id="header">
        <div class="header-content">

            <div class="device-info">
                <div class="status-led" id="statusLed"></div>
                <div class="device-name">JamMate</div>
            </div>

            <div class="header-right">

                <!-- Master + BPM knobs live in the header now -->
                <div id="globalKnobRow">
                    <div class="knob-container">
                        <div class="knob" id="masterKnob"></div>
                        <div class="knob-label">Master</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" id="bpmKnob"></div>
                        <div class="knob-label">BPM</div>
                    </div>
                </div>

                <button class="btn-fullscreen" id="btnFullscreen" title="Toggle Fullscreen">&#9974;</button>

                <button class="btn-fullscreen" id="btnConnect" title="Connect BLE" aria-label="Connect BLE">
                    <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                        <path fill="currentColor" d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/>
                    </svg>
                </button>

            </div>
        </div>
    </div>

    <!-- TABS -->
    <div class="tabs" id="tabs">
        <div class="tab active" data-tab="effects">Effects</div>
        <div class="tab" data-tab="drum">Drum</div>
        <div class="tab" data-tab="tuner">Tuner</div>
        <div class="tab" data-tab="setup">Setup</div>
        <div class="tab" data-tab="loader">Files</div>
        <div class="tab" data-tab="youtube">YouTube</div>
    </div>

    <!-- ============================================================
         EFFECTS TAB
         Preset row: [ðŸ’¾ Save] [ðŸ“± Easy]  |  [Bank â–¾] [Num â–¾]
         (Master/BPM knobs are now in the header above)
    ============================================================= -->
    <div class="tab-content active" id="effects-tab">

        <div class="preset-controls">
            <div class="preset-row" style="align-items: flex-end; flex-wrap: nowrap; gap: 6px;">

                <!-- Action buttons - icon only, minimal footprint -->
                <button id="btnSavePreset" class="btn-preset-action" title="Save Preset">&#128190;</button>
                <button id="btnEasyMode"   class="btn-preset-action" title="Toggle Easy Mode">&#128241;</button>

                <!-- Bank select -->
                <div style="display:flex; flex-direction:column; flex:1; min-width:0;">
                    <label class="control-label">Bank</label>
                    <select id="presetBank">
                        <option>Clean</option><option>Crunch</option><option>Overdrive</option>
                        <option>Distortion</option><option>Modulated</option>
                        <option>Custom1</option><option>Custom2</option>
                    </select>
                </div>

                <!-- Number select -->
                <div style="display:flex; flex-direction:column; flex:0 0 auto; width:80px;">
                    <label class="control-label">No.</label>
                    <select id="presetNum">
                        <option>1</option><option>2</option><option>3</option>
                        <option>4</option><option>5</option>
                    </select>
                </div>

            </div>
        </div>

        <div class="effects-scroll">
            <div class="effects-grid" id="effectsGrid"></div>
        </div>
        <div id="effectControls"></div>
    </div>

    <!-- ============================================================
         YOUTUBE TAB
    ============================================================= -->
    <div class="tab-content" id="youtube-tab">
        <div class="preset-controls">
            <h2 style="text-align:center; color:var(--color-accent); margin-bottom:10px;">YouTube Browser</h2>
        </div>
        <div class="youtube-wrapper">
            <iframe class="youtube-frame"
                src="https://www.youtube.com"
                title="YouTube Browser" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen referrerpolicy="strict-origin-when-cross-origin">
            </iframe>
        </div>
    </div>

    <!-- ============================================================
         DRUM TAB
    ============================================================= -->
    <div class="tab-content" id="drum-tab">

        <!-- Two panels side by side (stack on mobile) -->
        <div class="drum-panels">

            <!-- â”€â”€ DRUM PANEL â”€â”€ -->
            <div class="preset-controls drum-panel">
                <h3 class="panel-title">&#x1F941; Drum Machine</h3>

                <div class="panel-knob-row">
                    <div class="knob-container">
                        <div class="knob" id="drumLevelKnob"></div>
                        <div class="knob-label">Level</div>
                    </div>
                    <label class="checkbox panel-inline-check">
                        <input type="checkbox" id="drumEnable" checked>
                        <span>Enable</span>
                    </label>
                </div>

                <div class="panel-selects">
                    <div>
                        <label class="control-label">Style</label>
                        <select id="drumStyle" style="width:100%;">
                            <option value="0">Rock</option><option value="1">Blues</option>
                            <option value="2">Jazz</option><option value="3">Shuffle</option>
                            <option value="4">Pop</option><option value="5">Metal</option>
                            <option value="6">Latin</option><option value="7">R&amp;B</option>
                            <option value="8">Country</option><option value="9">Funk</option>
                            <option value="10">Pattern</option>
                        </select>
                    </div>
                    <div>
                        <label class="control-label">Fill</label>
                        <select id="drumFill" style="width:100%;">
                            <option value="0">None</option><option value="1">x1</option>
                            <option value="2">x4</option><option value="3">x12</option>
                            <option value="4">x16</option>
                        </select>
                    </div>
                    <div>
                        <label class="control-label">Number</label>
                        <select id="drumNumber" style="width:100%;">
                            <option value="1">1</option><option value="2">2</option>
                            <option value="3">3</option><option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- â”€â”€ LOOPER PANEL â”€â”€ -->
            <div class="preset-controls drum-panel">
                <h3 class="panel-title">&#x1F501; Looper</h3>

                <div class="panel-knob-row">
                    <div class="knob-container">
                        <div class="knob" id="loopLevelKnob"></div>
                        <div class="knob-label">Level</div>
                    </div>
                    <label class="checkbox panel-inline-check">
                        <input type="checkbox" id="looperEnable">
                        <span>Enable</span>
                    </label>
                </div>

                <div class="panel-selects">
                    <div>
                        <label class="control-label">Sync</label>
                        <select id="loopSync" style="width:100%;">
                            <option value="0">None</option>
                            <option value="1">Bar</option>
                            <option value="2">Beat</option>
                        </select>
                    </div>
                    <div>
                        <label class="control-label">Arm</label>
                        <select id="loopArm" style="width:100%;">
                            <option value="0">None</option>
                            <option value="1">Low</option>
                            <option value="2">High</option>
                        </select>
                    </div>
                    <div>
                        <label class="control-label">Loop Length</label>
                        <select id="loopLength" style="width:100%;">
                            <option value="0" selected>Custom</option>
                            <option value="4">4 bars</option>
                            <option value="8">8 bars</option>
                            <option value="12">12 bars</option>
                            <option value="16">16 bars</option>
                        </select>
                    </div>
                    <div>
                        <label class="control-label">Tracks</label>
                        <select id="loopTracks" style="width:100%;">
                            <option value="1">1</option><option value="2">2</option>
                            <option value="3">3</option><option value="4">4</option>
                        </select>
                    </div>
                </div>

                <!-- Save to SD lives in the looper panel -->
                <button id="btnSaveToSD" style="width:100%; height:42px; margin-top:14px; font-size:14px;">
                    &#128190; Save to SD
                </button>
            </div>

        </div><!-- /.drum-panels -->

        <div class="drum-grid" id="drumGrid"></div>
    </div>

    <!-- ============================================================
         TUNER TAB
    ============================================================= -->
    <div class="tab-content" id="tuner-tab">
        <div class="tuner-display">
            <label class="checkbox" style="justify-content:center; margin-bottom:20px;">
                <input type="checkbox" id="tunerEnable"><span>Enable Tuner</span>
            </label>
            <div class="string-display" id="stringDisplay">--</div>
            <div style="color:#888;">Target: <span id="targetFreq">-- Hz</span></div>
            <div class="tuner-gauge">
                <div class="tuner-center"></div>
                <div class="tuner-needle" id="tunerNeedle"></div>
            </div>
            <div class="freq-display" id="freqDisplay">-- Hz</div>
            <div style="color:#888; font-size:18px;" id="centsDisplay">-- cents</div>
        </div>
    </div>

    <!-- ============================================================
         SETUP TAB
    ============================================================= -->
    <div class="tab-content" id="setup-tab">

        <div class="preset-controls" style="border-bottom:2px solid var(--color-border); padding-bottom:15px; margin-bottom:15px;">
            <h2 style="text-align:center; color:var(--color-accent); margin-bottom:15px;">Interface</h2>
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                <button class="btn-fullscreen" id="btnTheme" title="Toggle Theme"
                        style="width:auto; padding:0 20px; height:50px; font-size:16px;">
                    &#127912; Theme
                </button>
            </div>
        </div>

        <div class="preset-controls">
            <h2 style="text-align:center; color:var(--color-accent); margin-bottom:16px;">Daisy Control</h2>

            <!-- 2-column grid for action buttons -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                <button id="reset-btn"       style="background:#f44; height:54px;">Reset Daisy</button>
                <button id="btnReadSDCard"   style="height:54px;">Read SD Card</button>
                <button id="flash-btn"       style="background:#f80; height:54px;">Flash Daisy</button>
                <button id="btnUpdateConfig" style="height:54px;" title="Upload config layout to ESP LittleFS">Update Config</button>
            </div>

            <!-- UART toggle â€“ full width, toggled by app.js; class .btn-uart-on added when active -->
            <button id="btnToggleUART" class="btn-uart" style="width:100%; height:54px; margin-bottom:16px;">
                UART: OFF
            </button>

            <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:15px; align-items:center;">
                <label class="checkbox"><input type="checkbox" id="btEnable"><span>Enable Bluetooth</span></label>
                <label class="checkbox"><input type="checkbox" id="bleEnable"><span>Enable BLE</span></label>
                <div class="knob-container"><div class="knob" id="blVolKnob"></div><div class="knob-label">BT Vol</div></div>
            </div>
        </div>

        <div class="preset-controls">
            <h2 style="text-align:center; color:var(--color-accent); margin-bottom:20px;">Utilities</h2>
            <div style="display:flex; gap:15px; align-items:flex-start; justify-content:center; margin-bottom:15px;">
                <button id="whiteNoiseBtn" class="util-toggle-btn">White<br>Noise</button>
                <div class="knob-container"><div class="knob" id="whiteNoiseLevelKnob"></div><div class="knob-label">Level</div></div>
            </div>
            <div style="display:flex; gap:15px; align-items:flex-start; justify-content:center;">
                <button id="toneBtn" class="util-toggle-btn">Tone</button>
                <div class="knob-container"><div class="knob" id="toneLevelKnob"></div><div class="knob-label">Level</div></div>
                <div class="knob-container" style="display:flex; flex-direction:column; align-items:center;">
                    <label style="color:var(--color-text-secondary); font-size:12px; margin-bottom:5px;">Freq</label>
                    <input type="number" id="toneFreqInput" value="670" min="20" max="20000"
                           style="width:60px; padding:5px; border:1px solid var(--color-border);
                                  background:var(--color-bg-surface); color:var(--color-text-primary);
                                  border-radius:4px; text-align:center;">
                </div>
            </div>
        </div>

    </div><!-- /#setup-tab -->

    <!-- ============================================================
         FILES TAB
    ============================================================= -->
    <div class="tab-content" id="loader-tab">
        <div class="preset-controls">
            <div class="file-upload-btn">
                <input type="file" id="fileInput" accept=".wav,audio/wav">
                <button onclick="document.getElementById('fileInput').click()">&#128194; Load WAV File</button>
            </div>
        </div>
        <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
        <canvas class="spectrum-canvas" id="spectrumCanvas"></canvas>
        <div class="preset-controls">
            <div>
                <label class="control-label">Points to Send</label>
                <select id="irPoints" style="width:fit-content;">
                    <option>128</option><option>256</option><option selected>512</option>
                    <option>1024</option><option>2048</option><option>4096</option><option>8192</option>
                </select>
            </div>
            <button id="btnSendIR" disabled>Send IR to Device</button>
        </div>
    </div>

    <!-- HUD -->
    <div id="status-bar"><span id="statusMessage">Ready</span></div>

    <!-- ============================================================
         SAVE PRESET MODAL
    ============================================================= -->
    <div id="saveModal" class="solo-effect-overlay" style="display:none;">
        <div class="solo-effect-container" style="width:300px; height:auto;">
            <div class="solo-effect-title">Save Preset To...</div>

            <div style="margin-bottom:15px;">
                <label class="control-label">Bank</label>
                <select id="saveBankSelect" style="width:100%; margin-top:5px; padding:10px;">
                    <option value="0">Clean</option><option value="1">Crunch</option>
                    <option value="2">Overdrive</option><option value="3">Distortion</option>
                    <option value="4">Modulated</option><option value="5">Custom1</option><option value="6">Custom2</option>
                </select>
            </div>

            <div style="margin-bottom:20px;">
                <label class="control-label">Slot</label>
                <select id="saveNumSelect" style="width:100%; margin-top:5px; padding:10px;">
                    <option value="0">1</option><option value="1">2</option><option value="2">3</option>
                    <option value="3">4</option><option value="4">5</option>
                </select>
            </div>

            <div style="display:flex; gap:10px;">
                <button id="btnConfirmSave" style="flex:1; background:var(--color-enabled); padding:10px;">Save</button>
                <button id="btnCancelSave"  style="flex:1; background:var(--color-error);   padding:10px;">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { app } from './js/app.js';
        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>
